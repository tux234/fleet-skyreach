- name: CIS - Ensure Access to Audit Records Is Controlled
  query: |
    SELECT 1 WHERE 
      -- For all files in /var/audit:
      -- UID, GID should be owned by root.
      -- MODE should be 0440 ("-r--r-----")
      NOT EXISTS ( SELECT 1 FROM file WHERE path LIKE '/var/audit/%' AND (uid !=0 OR gid !=0 OR mode != "0440") )
      AND 
      NOT EXISTS ( select 1 from file 
                        where path LIKE 
                        ( 
                            SELECT dir FROM 
                            ( 
                              -- The path we are looking for is written inside /etc/security/audit_control in a line that starts with "dir:"
                              -- Looking immediately at this and REGEX-ing the path after it (and concatenating "/%")
                              -- Same explanation for queries below.
                              select line, CONCAT(regex_match(line, '^dir:(.+)',1 ), '/%') AS dir 
                              FROM file_lines 
                              WHERE path = '/etc/security/audit_control' 
                              AND line LIKE "dir:%"
                            )
                        ) 
                        AND ( uid !=0 OR gid !=0 OR mode != "0440" )
                  ) 
      AND 
      -- For /etc/security/audit_control the MODE should be 0400 ("-r--------")
      NOT EXISTS ( select 1 from file where path = "/etc/security/audit_control" AND mode != "0400" );
  critical: false
  description: |
    The audit system on macOS writes important operational and security information that can be both useful for an attacker and a place for an attacker to attempt to obfuscate unwanted changes that were recorded. As part of defense-in-depth, the /etc/security/audit_control configuration and the files in /var/audit should be owned only by root with group wheel with read-only rights and no other access allowed. macOS ACLs should not be used for these files.

    The default folder for storing logs is /var/audit, but it can be changed. This recommendation will ensure that any target directory has appropriate access control in place even if the target directory is not the default of /var/audit.
  resolution: |
    Automated method:
    Ask your system administrator to deploy the following script which will Ensure Access to Audit Records Is Controlled:
      /usr/bin/sudo /usr/sbin/chown -R root:wheel /etc/security/audit_control
      /usr/bin/sudo /bin/chmod -R og-rw /etc/security/audit_control
      /usr/bin/sudo /usr/sbin/chown -R root:wheel $(/usr/bin/sudo /usr/bin/grep '^dir' /etc/security/audit_control | /usr/bin/awk -F: '{print $2}')
      /usr/bin/sudo /bin/chmod -R og-rw $(/usr/bin/sudo /usr/bin/grep '^dir' /etc/security/audit_control | /usr/bin/awk -F: '{print $2}')
  platform: darwin
