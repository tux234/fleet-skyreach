- name: CIS -  Ensure Logging Is Enabled for Sudo (MDM Required)
  query: |
    SELECT 1 
    FROM file_lines 
    WHERE path = '/etc/sudoers' 
      AND (
          -- No matching line
          NOT EXISTS (
              SELECT 1 
              FROM file_lines 
              WHERE path = '/etc/sudoers' 
                AND line LIKE '%!log_allowed%'
          ) 
          -- OR line exists but is commented
          AND NOT EXISTS (
              SELECT 1 
              FROM file_lines 
              WHERE path = '/etc/sudoers' 
                AND line LIKE '%#%Defaults%!log_allowed%'
          )
      ) 
    LIMIT 1;
  critical: false
  description: |
    In order to properly monitor the use of the sudo command, logs events for any use of sudo should be captured in the unified log.
  resolution: |
    Ask your system administrator to deploy a script that will configure:
      /usr/bin/sudo /usr/sbin/visudo -f /etc/sudoers
      Remove the line, or comment out with # before the line, 'Defaults !log_allowed'
  platform: darwin
